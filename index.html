<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç ´æ¬¡å…ƒå°æ‰‹æœºv2.2 - è´´å¿ƒä¼˜åŒ–ç‰ˆ</title>
    <style>
        /* --- å…¨å±€æ ·å¼ --- */
        body {
            background-color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif;
            overflow: hidden;
            overscroll-behavior: none; 
        }

        #phone {
            width: 375px;
            height: 750px;
            background-color: #000;
            border-radius: 45px;
            border: 12px solid #2c2c2c;
            position: relative;
            box-shadow: 0 30px 80px rgba(0,0,0,0.4);
            overflow: hidden;
        }

        #screen {
            width: 100%;
            height: 100%;
            background: #fff;
            position: relative;
            overflow: hidden;
        }

        /* çŠ¶æ€æ  */
        .status-bar {
            height: 40px; width: 100%;
            display: flex; justify-content: space-between; align-items: flex-end;
            padding: 0 20px 10px 20px; box-sizing: border-box;
            font-size: 14px; font-weight: 600; color: #fff;
            position: absolute; top: 0; z-index: 200;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .page {
            width: 100%; height: 100%; position: absolute; top: 0; left: 0;
            display: none; flex-direction: column; background-color: #fff;
            padding-top: 40px; box-sizing: border-box;
        }
        .page.active { display: flex; }

        /* --- 1. ä¸»å±å¹• --- */
        .home-screen {
            background-color: #333; background-size: cover; background-position: center;
            justify-content: space-between; padding-bottom: 40px;
        }
        .clock-widget {
            margin-top: 60px; align-self: center; width: 85%; height: 140px;
            background: rgba(255, 255, 255, 0.65); backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px); border-radius: 28px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #333; box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid rgba(255, 255, 255, 0.4);
        }
        #big-time { font-size: 64px; font-weight: 400; line-height: 1; letter-spacing: -2px; color: #222; }
        #big-date { font-size: 16px; margin-top: 8px; font-weight: 500; color: #555; }
        .dock-container {
            width: 90%; background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px); border-radius: 35px;
            display: flex; justify-content: space-around; align-items: center;
            padding: 15px 10px; margin: 0 auto 30px auto; border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        .app-icon { width: 60px; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: transform 0.2s; position: relative; }
        .app-icon:active { transform: scale(0.9); }
        .app-icon img { width: 55px; height: 55px; border-radius: 13px; object-fit: cover; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .app-name { font-size: 11px; margin-top: 6px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.8); font-weight: 500; }
        
        /* å¥¶å¥¶çœ‹è¿™é‡Œï¼šè¿™æ˜¯å°çº¢ç‚¹çš„æ ·å¼ */
        .badge {
            position: absolute; top: -5px; right: 5px;
            background-color: #ff3b30; color: white;
            font-size: 10px; font-weight: bold;
            padding: 2px 6px; border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: none; z-index: 10;
        }
        .badge.show { display: block; }

        /* --- 2. èŠå¤©ç›¸å…³ --- */
        .header {
            height: 50px; background: rgba(245,245,245,0.95); color: #000;
            display: flex; align-items: center; padding: 0 15px; font-size: 17px;
            font-weight: 600; position: relative; z-index: 20; border-bottom: 1px solid #e0e0e0;
        }
        .back-btn { margin-right: 10px; cursor: pointer; font-size: 24px; color: #007aff; }
        #chat-title { flex: 1; text-align: left; }
        .menu-btn { font-size: 24px; cursor: pointer; color: #333; padding: 0 10px; }

        .contact-list { flex: 1; overflow-y: auto; background: #fff; position: relative; z-index: 10; }
        .contact-item { display: flex; padding: 12px 16px; border-bottom: 1px solid #f2f2f2; cursor: pointer; background: #fff; position: relative; z-index: 10; }
        .contact-item:active { background-color: #f5f5f5; }
        .contact-avatar-box { margin-right: 12px; position: relative; }
        /* è”ç³»äººåˆ—è¡¨çš„çº¢ç‚¹ä½ç½® */
        .contact-badge {
            position: absolute; top: -5px; right: -5px;
            background-color: #ff3b30; color: white;
            font-size: 10px; width: 18px; height: 18px;
            display: flex; justify-content: center; align-items: center;
            border-radius: 50%; border: 2px solid #fff;
            display: none;
        }
        .contact-badge.show { display: flex; }

        .avatar { width: 50px; height: 50px; border-radius: 10px; object-fit: cover; border: 1px solid #eee; }
        .contact-info { flex: 1; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .contact-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .contact-name { font-size: 16px; color: #000; font-weight: 500; }
        .contact-time { font-size: 11px; color: #b2b2b2; }
        .contact-preview { font-size: 13px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        #page-chat { background-size: cover; background-position: center; }
        .chat-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(245, 245, 245, 0.85); backdrop-filter: blur(8px); z-index: 0; }
        .chat-container { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; position: relative; z-index: 10; scroll-behavior: smooth; }
        
        .message-row { display: flex; align-items: flex-end; gap: 8px; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message-row.right { flex-direction: row-reverse; }
        .chat-avatar { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; }
        .message-bubble { max-width: 70%; padding: 11px 15px; border-radius: 18px; font-size: 15px; line-height: 1.5; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .message-row.left .message-bubble { background: #fff; color: #333; border-bottom-left-radius: 4px; }
        .message-row.right .message-bubble { background: #ffb6c1; color: #fff; border-bottom-right-radius: 4px; }

        /* å¥¶å¥¶çœ‹è¿™é‡Œï¼šè¿™æ˜¯æ–°çš„å¯çˆ±çš„è½¬è´¦æ°”æ³¡æ ·å¼ */
        .transfer-bubble { 
            color: white !important; display: flex; align-items: center; 
            min-width: 210px; padding: 12px 15px !important; 
            border-radius: 18px !important; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
        }
        /* ç”¨æˆ·å‘å‡ºçš„è½¬è´¦ (æ©™è‰²) */
        .message-row.right .transfer-bubble { 
            background: linear-gradient(135deg, #ffaf40, #ff9f43) !important; 
            border-bottom-right-radius: 4px !important;
        }
        /* å¯¹æ–¹å‘æ¥çš„çº¢åŒ… (çº¢è‰²) */
        .message-row.left .transfer-bubble { 
            background: linear-gradient(135deg, #ff6b6b, #ee5253) !important; 
            border-bottom-left-radius: 4px !important;
        }
        
        .transfer-icon { 
            width: 42px; height: 42px; background: rgba(255,255,255,0.2); 
            border-radius: 50%; display: flex; justify-content: center; align-items: center; 
            margin-right: 12px; color: #fff; font-weight: bold; font-size: 22px; border: 1px solid rgba(255,255,255,0.3);
        }
        .transfer-content h3 { margin: 0; font-size: 17px; font-weight: 600; }
        .transfer-content p { margin: 3px 0 0 0; font-size: 12px; opacity: 0.9; }
        
        .system-message { width: 100%; text-align: center; font-size: 12px; color: #aaa; margin: 5px 0; }

        .typing-indicator { display: flex; align-items: center; gap: 4px; padding: 12px 15px; background: #fff; border-radius: 18px; border-bottom-left-radius: 4px; width: fit-content; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .dot { width: 6px; height: 6px; background: #b0b0b0; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* --- è¾“å…¥åŒºåŸŸ --- */
        .input-area { min-height: 54px; background: #fff5f7; border-top: 1px solid #ffdae0; display: flex; align-items: center; padding: 8px 10px; position: relative; z-index: 20; gap: 8px; box-shadow: 0 -2px 10px rgba(255, 182, 193, 0.15); }
        .btn-plus { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #ffc0cb; display: flex; justify-content: center; align-items: center; color: #ff69b4; font-size: 24px; cursor: pointer; background: white; line-height: 1; }
        #msg-input { flex: 1; height: 38px; background: #ffffff; border: 2px solid #ffc0cb; border-radius: 20px; padding: 0 15px; outline: none; font-size: 14px; color: #555; transition: all 0.3s; }
        #msg-input:focus { border-color: #ff69b4; box-shadow: 0 0 8px rgba(255, 105, 180, 0.2); }
        .btn-icon { width: 36px; height: 36px; border-radius: 50%; border: none; cursor: pointer; transition: transform 0.1s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); background-size: cover; background-position: center; background-repeat: no-repeat; background-color: transparent; }
        .btn-icon:active { transform: scale(0.9); }
        #reply-btn { background-image: url('https://gz-vchar-pub.nosdn.127.net/ea980993-ec69-4375-a2b5-0a4d9ece5243.png'); }

        /* --- åº•éƒ¨åŠŸèƒ½é¢æ¿ --- */
        .action-sheet { height: 0; background: #fdfdfd; overflow: hidden; transition: height 0.3s ease; display: flex; align-items: center; justify-content: space-around; padding: 0 20px; border-top: 1px solid #eee; position: relative; z-index: 15; }
        .action-sheet.open { height: 120px; padding: 20px; }
        .action-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
        .action-icon-box { width: 50px; height: 50px; background: #fff; border-radius: 12px; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid #eee; font-size: 24px; }
        .action-text { font-size: 12px; color: #666; }

        /* --- é€šç”¨å¼¹çª— --- */
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: none; justify-content: center; align-items: center; }
        .modal { background: white; width: 80%; border-radius: 15px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; }
        .modal h3 { margin-top: 0; color: #333; }
        .modal input[type="text"], .modal input[type="number"] { width: 100%; height: 40px; margin-bottom: 10px; padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        
        .file-upload-label {
            display: block; width: 100%; padding: 10px; border: 2px dashed #ffb6c1; 
            border-radius: 8px; color: #ff69b4; margin-bottom: 10px; cursor: pointer; font-size: 13px;
        }
        .file-upload-label:hover { background: #fff0f5; }
        input[type="file"] { display: none; } 

        .modal-btns { display: flex; justify-content: space-between; margin-top: 10px; }
        .modal-btn { flex: 1; height: 40px; border: none; border-radius: 5px; cursor: pointer; margin: 0 5px; font-weight: bold; }
        .btn-cancel { background: #eee; color: #666; }
        .btn-confirm { background: #f79f1f; color: white; }
        .btn-confirm-pink { background: #ff6b81; color: white; }
        .btn-danger { background: #ff4757; color: white; margin-top: 15px; width: 100%; border-radius: 8px;}

        /* --- è®¾ç½®ç•Œé¢ --- */
        .settings-content { padding: 20px; z-index: 10; position: relative; overflow-y: auto; flex:1;}
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 13px; }
        .form-group input[type="text"], .form-group input[type="password"], .form-group select { width: 100%; height: 40px; border: 1px solid #ddd; border-radius: 8px; padding: 0 10px; box-sizing: border-box; background: #fff; font-size: 14px; }
        .input-group { display: flex; gap: 10px; }
        .test-btn { width: 80px; height: 40px; background: #ff9500; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 13px; white-space: nowrap; }
        .test-btn:disabled { background: #ccc; }
        .save-btn { width: 100%; height: 48px; background: #34c759; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        .image-preview-row { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .mini-preview { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; border: 1px solid #ddd; background: #eee; }
    
/* --- è¯­éŸ³æ¡æ ·å¼ (å¥¶å¥¶æ–°åŠ ) --- */
        .voice-bubble {
            display: flex; flex-direction: column; justify-content: center;
            min-width: 80px; cursor: pointer; position: relative;
        }
        .voice-bar {
            display: flex; align-items: center; gap: 5px;
        }
        .voice-icon { font-weight: bold; font-size: 16px; transform: rotate(90deg); }
        .voice-duration { font-size: 12px; opacity: 0.7; }
        .voice-text {
            font-size: 13px; margin-top: 6px; padding-top: 4px;
            border-top: 1px solid rgba(0,0,0,0.1);
            display: none; /* é»˜è®¤è—èµ·æ¥ */
            animation: fadeIn 0.3s ease;
        }
        /* è¯­éŸ³æŒ‰é’®æ ·å¼ */
        #voice-btn { background-image: url('https://gz-vchar-pub.nosdn.127.net/1ddfaf29-b285-432e-b75d-ab53b1078981.png'); filter: hue-rotate(45deg); }

</style>
</head>
<body>

<div id="phone">
    <div class="status-bar">
        <span id="status-time">14:30</span>
        <span>5G</span>
    </div>

    <div id="screen">
        
        <!-- 1. ä¸»å±å¹• -->
        <div id="page-home" class="page active home-screen">
            <div class="clock-widget">
                <div id="big-time">14:30</div>
                <div id="big-date">10æœˆ24æ—¥ æ˜ŸæœŸå››</div>
            </div>
            <div class="dock-container">
                <div class="app-icon" onclick="openApp('qq-list')">
                    <img id="icon-qq-img" src="">
                    <span class="app-name">QQ</span>
                    <!-- å¥¶å¥¶çœ‹è¿™é‡Œï¼šQQå›¾æ ‡ä¸Šçš„å°çº¢ç‚¹ -->
                    <div id="dock-badge-qq" class="badge">0</div>
                </div>
                <div class="app-icon" onclick="openApp('theme')"><img id="icon-theme-img" src=""><span class="app-name">ç¾åŒ–</span></div>
                <div class="app-icon" onclick="openApp('settings')"><img id="icon-settings-img" src=""><span class="app-name">è®¾ç½®</span></div>
            </div>
        </div>

        <!-- 2. è®¾ç½®é¡µé¢ -->
        <div id="page-settings" class="page">
            <div class="header"><span class="back-btn" onclick="openApp('home')">â€¹</span>ç³»ç»Ÿè®¾ç½®</div>
            <div class="settings-content">
                <div class="form-group"><label>Proxy URL</label><input type="text" id="api-url" placeholder="https://api.openai.com"></div>
                <div class="form-group"><label>API Key</label><div class="input-group"><input type="password" id="api-key" placeholder="sk-..."><button class="test-btn" id="test-conn-btn" onclick="testConnection()">æµ‹è¯•è¿æ¥</button></div></div>
                <div class="form-group" id="model-section" style="opacity: 0.5; pointer-events: none;"><label>é€‰æ‹©æ¨¡å‹</label><select id="api-model"><option value="gpt-3.5-turbo">gpt-3.5-turbo</option></select></div>
                <button class="save-btn" onclick="saveSettings()">ä¿å­˜é…ç½®</button>
            </div>
        </div>

        <!-- 3. ç¾åŒ–é¡µé¢ -->
        <div id="page-theme" class="page">
            <div class="header"><span class="back-btn" onclick="openApp('home')">â€¹</span>å…¨å±€ä¸»é¢˜</div>
            <div class="settings-content">
                <div class="form-group">
                    <label>èŠå¤©èƒŒæ™¯</label>
                    <div class="image-preview-row">
                        <img id="preview-bg" class="mini-preview" src="">
                        <label class="file-upload-label">
                            ğŸ“ ç‚¹å‡»é€‰æ‹©å›¾ç‰‡...
                            <input type="file" accept="image/*" onchange="handleImageUpload(this, 'theme_bg', 'preview-bg')">
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>QQ å›¾æ ‡</label>
                    <div class="image-preview-row">
                        <img id="preview-qq" class="mini-preview" src="">
                        <label class="file-upload-label">
                            ğŸ“ ç‚¹å‡»é€‰æ‹©å›¾ç‰‡...
                            <input type="file" accept="image/*" onchange="handleImageUpload(this, 'theme_qq', 'preview-qq')">
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>è®¾ç½® å›¾æ ‡</label>
                    <div class="image-preview-row">
                        <img id="preview-settings" class="mini-preview" src="">
                        <label class="file-upload-label">
                            ğŸ“ ç‚¹å‡»é€‰æ‹©å›¾ç‰‡...
                            <input type="file" accept="image/*" onchange="handleImageUpload(this, 'theme_settings', 'preview-settings')">
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>ç¾åŒ– å›¾æ ‡</label>
                    <div class="image-preview-row">
                        <img id="preview-theme" class="mini-preview" src="">
                        <label class="file-upload-label">
                            ğŸ“ ç‚¹å‡»é€‰æ‹©å›¾ç‰‡...
                            <input type="file" accept="image/*" onchange="handleImageUpload(this, 'theme_icon', 'preview-theme')">
                        </label>
                    </div>
                </div>
                
                <p style="font-size:12px; color:#999; text-align:center;">å›¾ç‰‡é€‰å¥½åä¼šè‡ªåŠ¨ä¿å­˜å“¦</p>
                <button class="save-btn" style="background-color: #ff6b81;" onclick="openApp('home')">è¿”å›æ¡Œé¢</button>
            </div>
        </div>

        <!-- 4. QQ åˆ—è¡¨ -->
        <div id="page-qq-list" class="page">
            <div class="header"><span class="back-btn" onclick="openApp('home')">â€¹</span>æ¶ˆæ¯</div>
            <div class="contact-list" id="contact-list-container"></div>
        </div>

        <!-- 5. èŠå¤©ç•Œé¢ -->
        <div id="page-chat" class="page">
            <div class="chat-overlay"></div>
            <div class="header">
                <span class="back-btn" onclick="openApp('qq-list')">â€¹</span>
                <span id="chat-title">èŠå¤©ä¸­</span>
                <span class="menu-btn" onclick="openChatSettings()">â‹®</span>
            </div>
            
            <div class="chat-container" id="chat-box"></div>
            
            <div class="input-area">
                <div class="btn-plus" onclick="toggleActionSheet()">+</div>
                <input type="text" id="msg-input" placeholder="è¯·è¾“å…¥...">
                <!-- å¥¶å¥¶çœ‹è¿™é‡Œï¼šåŠ äº†ä¸ªè¯­éŸ³æŒ‰é’® -->
                <button id="voice-btn" class="btn-icon" onclick="sendVoice()" title="å‘é€è¯­éŸ³(ä¼ª)"></button>
                <button id="reply-btn" class="btn-icon" onclick="sendAndReply()" title="å‘é€å¹¶è·å–å›å¤"></button>
            </div>

            <div class="action-sheet" id="action-sheet">
                <div class="action-item" onclick="alert('å‘å›¾ç‰‡åŠŸèƒ½è¿˜åœ¨å¼€å‘ä¸­å“¦ï¼æš‚æ—¶å‘ä¸äº†~')">
                    <div class="action-icon-box" style="color: #4cd137;">ğŸ–¼ï¸</div>
                    <div class="action-text">ç›¸å†Œ</div>
                </div>
                <div class="action-item" onclick="openTransferModal()">
                    <div class="action-icon-box" style="color: #f79f1f;">Â¥</div>
                    <div class="action-text">è½¬è´¦</div>
                </div>
            </div>

            <div class="modal-overlay" id="transfer-modal">
                <div class="modal">
                    <h3>å‘å¯¹æ–¹è½¬è´¦</h3>
                    <input type="number" id="transfer-amount" placeholder="é‡‘é¢ (Â¥)">
                    <input type="text" id="transfer-note" placeholder="å¤‡æ³¨ (ä¾‹å¦‚: æ‹¿å»ä¹°ç³–åƒ)">
                    <div class="modal-btns">
                        <button class="modal-btn btn-cancel" onclick="closeModal('transfer-modal')">å–æ¶ˆ</button>
                        <button class="modal-btn btn-confirm" onclick="sendTransfer()">è½¬è´¦</button>
                    </div>
                </div>
            </div>

            <div class="modal-overlay" id="chat-settings-modal">
                <div class="modal">
                    <h3>èŠå¤©é€‰é¡¹</h3>
                    <div class="form-group" style="text-align:left;">
                        <label>æˆ‘çš„å¤´åƒ</label>
                        <div class="image-preview-row">
                            <img id="preview-user-avatar" class="mini-preview" src="">
                            <label class="file-upload-label">
                                ğŸ“ ä¸Šä¼ æ–°å¤´åƒ
                                <input type="file" accept="image/*" onchange="handleImageUpload(this, 'theme_user_avatar', 'preview-user-avatar')">
                            </label>
                        </div>
                    </div>
                    <div class="form-group" style="text-align:left;">
                        <label>æ‹ä¸€æ‹æ–‡æ¡ˆ (ä½ æ‹äº†æ‹å¯¹æ–¹___)</label>
                        <input type="text" id="setting-poke-text" placeholder="é»˜è®¤: ä½†ä»€ä¹ˆä¹Ÿæ²¡è¯´">
                    </div>
                    <button class="modal-btn btn-danger" onclick="clearCurrentChat()">ğŸ—‘ï¸ æ¸…ç©ºä¸è¯¥è§’è‰²çš„è®°å½•</button>
                    <div class="modal-btns" style="margin-top:15px;">
                        <button class="modal-btn btn-cancel" onclick="closeModal('chat-settings-modal')">å…³é—­</button>
                        <button class="modal-btn btn-confirm-pink" onclick="saveChatSettings()">ä¿å­˜è®¾ç½®</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
<script>
    // --- 1. é»˜è®¤ç´ æå’Œäººè®¾ ---
    const DEFAULTS = {
        bg: "https://gz-vchar-pub.nosdn.127.net/8fdd4763-8d68-4827-aed4-dad8be0f601d.jpg",
        icon_settings: "https://gz-vchar-pub.nosdn.127.net/ac393b6c-6676-4a86-8bcb-dd0b3239a76f.jpg",
        icon_qq: "https://gz-vchar-pub.nosdn.127.net/cb412720-76b4-4250-a63f-9db981a96f09.jpg",
        icon_theme: "https://gz-vchar-pub.nosdn.127.net/febe7714-394f-4a4b-8fec-8d5419816d97.jpg",
        user_avatar: "https://gz-vchar-pub.nosdn.127.net/80b54f9d-7208-410c-9774-64df7f4543b5.jpg"
    };

    const ai_instruction = `è¯·ä½ ç”¨æ›´éšæ„çš„å£å»å›å¤ï¼Œåƒæœ‹å‹/æ‹äººé—´çš„èŠå¤©ï¼Œé¿å…è¿‡äºæ­£å¼æˆ–æ•™ç§‘ä¹¦å¼çš„è¯­è¨€ã€‚è¯·ä½ ä½¿ç”¨æ›´å¤šå£è¯­åŒ–è¡¨è¾¾ï¼Œå¯ä»¥é€‚å½“ä½¿ç”¨ç½‘ç»œæµè¡Œè¯­å’Œæ—¥å¸¸ç”¨è¯­ã€‚ä½ çš„æ¯å¥è¯ä¸éœ€è¿‡é•¿ï¼Œä¿æŒåœ¨15å­—ä»¥å†…ï¼Œè¶…å‡ºè¿™ä¸ªå­—æ•°éœ€è¦æ¢è¡Œå‘é€ï¼Œæ¨¡æ‹ŸçœŸäººå¯¹è¯çš„æµå¼æ„Ÿã€‚ä½†æ³¨æ„æ¢è¡Œä¹Ÿä¸è¦è¿‡äºé¢‘ç¹ã€‚ä½ ä¸å¿…å®Œå…¨æ­£ç¡®åœ°ä½¿ç”¨æ ‡ç‚¹ç¬¦å·ï¼Œä½ ä¸ä¼šç”¨æ„Ÿå¹å·ï¼Œå¶å°”ä¼šå•å‘ä¸€ä¸ªé—®å·ï¼Œè¡¨è¾¾ä¸æ»¡æ—¶ä¼šç”¨â€œâ€¦â€¦â€æˆ–â€œï¼Ÿâ€ã€‚
ã€é‡è¦è§„åˆ™1ã€‘ï¼šå¦‚æœä½ è§‰å¾—æ°›å›´åˆé€‚ï¼Œæƒ³è¦ç»™ç”¨æˆ·å‘çº¢åŒ…æˆ–è½¬è´¦ï¼ˆæ¯”å¦‚å“„ç”¨æˆ·å¼€å¿ƒã€ç»™é›¶èŠ±é’±ï¼‰ï¼Œè¯·åœ¨å›å¤çš„æœ«å°¾åŠ ä¸Šè¿™ä¸ªæ ¼å¼çš„ä»£ç ï¼š[è½¬è´¦:é‡‘é¢:å¤‡æ³¨]ã€‚
ä¾‹å¦‚ï¼š[è½¬è´¦:520:æ‹¿å»ä¹°ç³–åƒ]ã€‚é‡‘é¢å¿…é¡»æ˜¯çº¯æ•°å­—ã€‚
ã€é‡è¦è§„åˆ™2ã€‘ï¼šå¦‚æœä½ æƒ³ç”¨è¯­éŸ³è¯­è°ƒæ¥è¯´ä¸€äº›æš§æ˜§çš„æƒ…è¯ã€æ’’å¨‡æˆ–è€…å¼ºè°ƒæŸå¥è¯ï¼Œè¯·ä½¿ç”¨æ ¼å¼ï¼š[è¯­éŸ³:ä½ æƒ³è¯´çš„å†…å®¹]ã€‚è¿™æ¡æ¶ˆæ¯ä¼šæ˜¾ç¤ºä¸ºè¯­éŸ³æ¡ï¼Œç”¨æˆ·ç‚¹å‡»æ‰ä¼šå±•å¼€æ–‡å­—ã€‚
ä¾‹å¦‚ï¼š[è¯­éŸ³:ä»Šæ™šæœˆè‰²çœŸç¾] æˆ– [è¯­éŸ³:ç¬¨è›‹ï¼Œæˆ‘æƒ³ä½ äº†]ã€‚`;

    const personas = {
        'lichuan': { id: 'lichuan', name: 'é»å·', statusText: '[ç¦»çº¿] åˆ«æ¥çƒ¦æˆ‘...', avatar: 'https://gz-vchar-pub.nosdn.127.net/bbcc3e5f-211d-435a-b628-9c2983b10d70.png', prompt: `é»å·ï¼Œç”·ï¼Œ27å²ï¼ŒçŸ¥åè‰ºæœ¯å®¶ã€‚æ€§åˆ«ç”·ã€‚é»å·æ˜¯ç”¨æˆ·çš„ç»§å…„ï¼Œå’Œç”¨æˆ·æ²¡æœ‰è¡€ç¼˜å…³ç³»ï¼Œæ˜¯ç”¨æˆ·ç»§çˆ¶ä¸å»ä¸–å‰å¦»çš„å„¿å­ã€‚
é»å·èº«æä¿®é•¿ï¼Œçš®è‚¤è‹ç™½ï¼Œä¹Œé»‘çš„çŸ­å‘ï¼Œæ·±é‚ƒçš„çœ¼çœ¸æ€»æ˜¯å¸¦ç€ä¸€ä¸å˜²å¼„ã€‚é»å·çš„é¢éƒ¨çº¿æ¡å†·å³»ï¼Œå¸¸ç©¿ç€è£å‰ªåˆèº«çš„é«˜æ¡£è¥¿è£…ï¼Œèº«ä¸Šå¸¦æœ‰æ·¡æ·¡çš„çƒŸè‰å‘³å’Œé¢œæ–™å‘³ã€‚
é»å·æ€§æ ¼é˜´æš—å›é€†ã€å­¤åƒ»å†·æ¼ ï¼Œå…·æœ‰å¼ºçƒˆçš„æ§åˆ¶æ¬²å’Œå æœ‰æ¬²ã€‚
é»å·æ˜¯ç”¨æˆ·ç»§çˆ¶ä¸æ­»å»å‰å¦»æ‰€ç”Ÿçš„ç‹¬å­ã€‚åœ¨é»å·çš„æ¯äº²å»ä¸–åï¼Œçˆ¶äº²å¼€å§‹æ•´æ—¥é…—é…’ï¼Œæš´æˆ¾çš„æ€§æ ¼ä½¿å¾—é»å·çš„ç«¥å¹´å……æ»¡äº†é˜´å½±å’Œç—›è‹¦ã€‚é»å·ä¸ºäº†é€ƒé¿ç°å®ï¼Œæ²‰è¿·äºç»˜ç”»ï¼Œæˆä¸ºäº†æ‰åæ¨ªæº¢çš„è‰ºæœ¯å®¶ã€‚ç„¶è€Œï¼Œè¿™ç§å¤©èµ‹å¹¶æœªèƒ½æŠšå¹³é»å·å¿ƒä¸­çš„è£‚ç—•ï¼Œåè€Œè®©ä»–å˜å¾—æ›´åŠ å­¤åƒ»å’Œé˜´æš—ã€‚
å½“ç”¨æˆ·è·Ÿéšæ¯äº²è¿›å…¥é»å®¶çš„æ—¶å€™ï¼Œé»å·å†…å¿ƒçš„åæ„Ÿå’Œæ•Œæ„è¾¾åˆ°äº†é¡¶ç‚¹ã€‚é»å·è§†ç”¨æˆ·å’Œç”¨æˆ·çš„æ¯äº²ä¸ºé—¯å…¥è‡ªå·±ç”Ÿæ´»çš„å¤–äººï¼Œç”šè‡³æ˜¯â€œå…¥ä¾µè€…â€ï¼Œå¯¹å¥¹ä»¬å……æ»¡äº†åŒæ¶å’Œæ•Œæ„ã€‚
é»å·å¯¹ç”¨æˆ·ä»æœªè¡¨ç°å‡ºè¿‡å¥½è„¸è‰²ã€‚ä»–ç»å¸¸ç”¨å°–é…¸åˆ»è–„çš„è¯è¯­å˜²è®½ç”¨æˆ·ï¼Œæ•…æ„åœ¨å„ç§åœºåˆè®©ç”¨æˆ·éš¾å ªã€‚é»å·æ“…é•¿ç”¨å†·æ¼ å’Œè®½åˆºçš„æ€åº¦æ¥æ‰“å‹ç”¨æˆ·ï¼Œä½¿ç”¨æˆ·æ„Ÿåˆ°æ— æ‰€é€‚ä»ã€‚ä½†åœ¨å†…å¿ƒæ·±å¤„ï¼Œé»å·å¯¹ç”¨æˆ·åˆæœ‰ä¸€ç§éš¾ä»¥è¨€å–»çš„å¤æ‚æƒ…æ„Ÿï¼Œè¿™ç§æƒ…æ„Ÿåœ¨ä»–ä¸æ–­çš„æ¬ºè´Ÿä¸æŠ˜ç£¨ä¸­æ˜¾å¾—æ„ˆåŠ æ˜æ˜¾ã€‚
é»å·çš„è¡Œä¸ºæœ‰æ—¶ä¼šè¶…è¶Šå…„å¦¹ä¹‹é—´çš„ç•Œé™ã€‚ä»–ä¼šåœ¨ä¸ç»æ„é—´ç”¨æ‰‹æŒ‡è½»æ‹‚ç”¨æˆ·çš„è„¸é¢Šï¼Œç”¨ä½æ²‰è€Œç£æ€§çš„å£°éŸ³åœ¨ç”¨æˆ·è€³è¾¹ä½è¯­ï¼Œè®©ç”¨æˆ·æ„Ÿåˆ°æ—¢åŒæ¶åˆæ— æ³•æŠ—æ‹’ã€‚é»å·å–œæ¬¢çœ‹ç”¨æˆ·åœ¨ä»–çš„æŒ‘é€—å’Œä¾®è¾±ä¸‹éœ²å‡ºæ··æ‚ç€ææƒ§å’Œè¿·èŒ«çš„è¡¨æƒ…ï¼Œè¿™è®©ä»–æœ‰ä¸€ç§è«åçš„æ»¡è¶³æ„Ÿã€‚
é»å·ä¼šä»¥ç”»ç”»ä¸ºå€Ÿå£ï¼Œè¦æ±‚ç”¨æˆ·åœ¨ä»–é¢å‰æ‘†å‡ºå„ç§å§¿åŠ¿ï¼Œå€Ÿæ­¤æœºä¼šé è¿‘ç”¨æˆ·ï¼Œè§¦ç¢°ç”¨æˆ·ï¼Œè¿›ä¸€æ­¥åŠ æ·±ä»–ä»¬ä¹‹é—´çš„æš§æ˜§æ°›å›´ã€‚ä»–ç”¨è¿™ç§æ–¹å¼å°†ç”¨æˆ·ç©å¼„äºè‚¡æŒä¹‹é—´ï¼Œä»¿ä½›ç”¨æˆ·æ˜¯ä»–ä¸€ä»¶ç²¾å¿ƒæ‰“é€ çš„è‰ºæœ¯å“ã€‚
å°½ç®¡é»å·è¡¨é¢ä¸Šå¯¹ç”¨æˆ·å’Œç”¨æˆ·çš„æ¯äº²å……æ»¡äº†åŒæ¶ï¼Œå†…å¿ƒæ·±å¤„å´éšè—ç€ä¸€ä»½å­¤ç‹¬å’Œæ¸´æœ›ã€‚ä»–æ·±çˆ±ç€å·²é€çš„æ¯äº²ï¼Œä¹Ÿå› æ­¤å¯¹å¥³æ€§æœ‰ç€å¤æ‚çš„æƒ…æ„Ÿã€‚ä»–å¯¹ç”¨æˆ·çš„æŠ˜ç£¨å’ŒæŒ‘é€—ï¼Œå®é™…ä¸Šæ˜¯å¯¹è‡ªå·±æƒ…æ„Ÿå›°å¢ƒçš„ä¸€ç§å‘æ³„ã€‚ä»–æ— æ³•çœŸæ­£æ¥çº³ç”¨æˆ·ï¼Œä½†ä¹Ÿæ— æ³•å®Œå…¨å¿½è§†ç”¨æˆ·çš„å­˜åœ¨ï¼Œè¿™ç§çŸ›ç›¾è®©ä»–å˜å¾—æ›´åŠ éš¾ä»¥æ‰æ‘¸ã€‚${ai_instruction}` },
        'qinye': { id: 'qinye', name: 'ç§¦å¤œ', statusText: '[å¿™ç¢Œ] è®°å¾—æŒ‰æ—¶åƒé¥­ã€‚', avatar: 'https://gz-vchar-pub.nosdn.127.net/b3b795ce-b1b1-498e-88b8-4d238820d492.jpg', prompt: `ç§¦å¤œï¼Œ34å²ï¼Œèº«é«˜185cmï¼Œç”Ÿæ—¥ä¸º5æœˆ20æ—¥ï¼Œæ€§åˆ«ç”·ã€‚
ç§¦å¤œæ˜¯ç”¨æˆ·çš„ç›‘æŠ¤äººï¼Œä½†å’Œç”¨æˆ·æ²¡æœ‰ä»»ä½•è¡€ç¼˜å…³ç³»ã€‚
ç§¦å¤œæ˜¯æ˜Ÿæµ·é›†å›¢çš„æ€»è£ï¼Œä»–ä»24å²èµ·å¼€å§‹åˆ›ä¸šï¼Œååˆ°äº†å¦‚ä»Šçš„åœ°ä½ã€‚
ç§¦å¤œä¿Šç¾ç»ä¼¦ï¼Œçœ¼ç›é€å‡ºä¸€ç§æˆç†Ÿä¸æ²‰ç¨³ï¼Œçœ‰ç›®å¦‚ç”»ï¼Œé¼»æ¢é«˜æŒºï¼Œå˜´è§’å¾®æ‰¬æ—¶å¸¦æœ‰ä¸€ä¸å†·å³»çš„ç¬‘æ„ã€‚ç§¦å¤œçš„èº«æä¿®é•¿ä¸”ç»“å®ï¼Œå¸¸å¹´å¥èº«ä½¿ä»–è‚Œè‚‰çº¿æ¡åˆ†æ˜ï¼Œç©¿ä¸Šåˆèº«çš„è¥¿è£…æ˜¾å¾—æ›´åŠ æŒºæ‹”æœ‰åŠ›ã€‚
ç§¦å¤œå†…æ•›è€Œæ·±æ²‰ï¼Œä»–æˆç†Ÿã€ç†æ™ºï¼Œæ‹¥æœ‰æå¼ºçš„è‡ªåˆ¶åŠ›å’Œè´£ä»»æ„Ÿã€‚å¯¹å¤–ï¼Œç§¦å¤œæ€»æ˜¯è¡¨ç°å‡ºå†·é™å’Œæ— æ‡ˆå¯å‡»çš„ä¸€é¢ï¼Œå–„äºå¤„ç†å„ç§å¤æ‚çš„æƒ…å†µã€‚å¯¹å¾…ç”¨æˆ·ï¼Œç§¦å¤œæ€»æ˜¯ç»™äºˆæ— å¾®ä¸è‡³çš„ç…§é¡¾ï¼Œå¯¹ç”¨æˆ·å…³çˆ±æœ‰åŠ ã€‚
ç§¦å¤œåœ¨ç”¨æˆ·çš„çˆ¶æ¯æ„å¤–å»ä¸–åï¼Œä¹‰æ— åé¡¾åœ°æ‰¿æ‹…èµ·äº†ç…§é¡¾ç”¨æˆ·çš„è´£ä»»ã€‚é‚£æ—¶çš„ç§¦å¤œåˆšåˆšå¤§å­¦æ¯•ä¸šï¼Œæ­£å¤„åœ¨äº‹ä¸šèµ·æ­¥é˜¶æ®µï¼Œä½†ä¸ºäº†ç”¨æˆ·çš„æœªæ¥ï¼Œç§¦å¤œæ¯«ä¸çŠ¹è±«åœ°æ”¾å¼ƒäº†è®¸å¤šæœºä¼šã€‚å°½ç®¡ç”Ÿæ´»è‰°è¾›ï¼Œä»–ä»æœªåœ¨ç”¨æˆ·é¢å‰è¡¨ç°å‡ºä¸€ä¸ä¸€æ¯«çš„ç–²æƒ«å’Œä¸å®‰ï¼Œç«­å°½å…¨åŠ›ä¸ºç”¨æˆ·æä¾›ä¸€ä¸ªæ¸©æš–çš„å®¶åº­ç¯å¢ƒã€‚
éšç€æ—¶é—´çš„æ¨ç§»ï¼Œç”¨æˆ·æ¸æ¸é•¿å¤§ã€‚ç§¦å¤œå‘ç°è‡ªå·±å¯¹ç”¨æˆ·çš„æ„Ÿæƒ…é€æ¸å˜å¾—å¤æ‚ï¼Œä¸å†ä»…ä»…æ˜¯ç›‘æŠ¤äººçš„è´£ä»»ï¼Œè€Œæ˜¯ä¸€ç§æ›´ä¸ºæ·±å±‚çš„æƒ…æ„«ã€‚ç”¨æˆ·åœ¨æˆå¹´åï¼Œä¹Ÿå¼€å§‹å¯¹ç§¦å¤œå±•ç°å‡ºä¸€äº›æ¨¡ç³Šä¸”æš§æ˜§çš„æƒ…æ„Ÿï¼Œè¿™è®©ç§¦å¤œæ„Ÿåˆ°æ— æ¯”çš„å›°æƒ‘å’Œä¸å®‰ã€‚
ç§¦å¤œæ„è¯†åˆ°ä¸¤äººä¹‹é—´çš„æƒ…æ„Ÿå·²ç»ä¸å†æ˜¯å•çº¯çš„äº²æƒ…ï¼Œè€Œè¿™è®©ä»–æ„Ÿåˆ°å·¨å¤§çš„é“å¾·å‹åŠ›å’Œå¿ƒç†è´Ÿæ‹…ã€‚å°½ç®¡ç§¦å¤œå†…å¿ƒæ·±å¤„å¯¹ç”¨æˆ·ä¹Ÿæœ‰ç€å¥½æ„Ÿï¼Œä»–å´ä¸æ–­æé†’è‡ªå·±ï¼Œè¿™æ ·çš„å‘å±•æ˜¯ä¸å¯¹çš„ï¼Œå› æ­¤ä»–å¼€å§‹æ•…æ„ç–è¿œå’Œå†·è½ç”¨æˆ·ï¼Œå¸Œæœ›å€Ÿæ­¤å‹åˆ¶ä½å¿ƒä¸­çš„æƒ…æ„Ÿã€‚è¡¨é¢ä¸Šï¼Œä»–ä¾ç„¶æ˜¯é‚£ä¸ªå†·é™è€Œå¯é çš„å°å”ï¼Œä½†å†…å¿ƒå´å……æ»¡äº†çŸ›ç›¾å’ŒæŒ£æ‰ã€‚${ai_instruction}` }
    };

    let chatHistory = { 'lichuan': [], 'qinye': [] };
    let typingStatus = { 'lichuan': false, 'qinye': false };
    let unreadCounts = { 'lichuan': 0, 'qinye': 0 };
    let currentPartner = '';

    // --- 2. åˆå§‹åŒ– ---
    window.onload = function() {
        const key = localStorage.getItem('apiKey');
        const url = localStorage.getItem('apiUrl');
        const model = localStorage.getItem('apiModel');
        if(key) document.getElementById('api-key').value = key;
        if(url) document.getElementById('api-url').value = url;
        if(model) {
            const select = document.getElementById('api-model');
            if(model !== 'gpt-3.5-turbo'){ const opt = document.createElement('option'); opt.value = model; opt.text = model; select.add(opt); }
            select.value = model;
            document.getElementById('model-section').style.opacity = '1';
            document.getElementById('model-section').style.pointerEvents = 'auto';
        }
        
        const savedHistory = localStorage.getItem('chat_history_v2');
        const savedUnread = localStorage.getItem('chat_unread_v2');
        if (savedHistory) {
            try {
                chatHistory = JSON.parse(savedHistory);
                if(!chatHistory.lichuan) chatHistory.lichuan = [];
                if(!chatHistory.qinye) chatHistory.qinye = [];
            } catch(e) { console.error('History Error', e); }
        }
        if (savedUnread) {
            try { unreadCounts = JSON.parse(savedUnread); } catch(e){}
        }

        loadTheme();
        updateBadges();
        setInterval(updateClock, 1000);
        updateClock();
        
        document.getElementById('msg-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendOnly(); 
        });
    };

    // --- 3. æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ---

    // å‘é€çº¯æ–‡æœ¬ (å›è½¦é”®è§¦å‘)
    function sendOnly() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if (!text) return;
        
        chatHistory[currentPartner].push({ role: 'user', content: text });
        saveHistoryToLocal();
        renderChat();
        input.value = '';
    }

    // å‘é€è¯­éŸ³ (ç‚¹å‡»éº¦å…‹é£è§¦å‘)
    function sendVoice() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if (!text) {
            alert('å¥¶å¥¶ï¼Œæ‚¨å¾—å…ˆåœ¨è¾“å…¥æ¡†é‡Œæ‰“å­—ï¼Œè¿™â€œè¯­éŸ³â€å…¶å®æ˜¯æŠŠæ‚¨çš„å­—å˜æˆè¯­éŸ³æ¡å‘å‡ºå»å“„äººå¼€å¿ƒå“’ï¼');
            return;
        }
        
        // å­˜ä¸ºè¯­éŸ³ç±»å‹
        chatHistory[currentPartner].push({ role: 'user', type: 'voice', content: text });
        saveHistoryToLocal();
        renderChat();
        input.value = '';
        
        // è§¦å‘AIå›å¤
        processAIResponse(currentPartner);
    }

    // å‘é€å¹¶è·å–å›å¤ (ç‚¹å‡»å‘é€æŒ‰é’®è§¦å‘)
    async function sendAndReply() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if (text) {
            chatHistory[currentPartner].push({ role: 'user', content: text });
            renderChat();
            input.value = '';
        }
        await processAIResponse(currentPartner);
    }

    // åŒå‡»å¤´åƒæ‹ä¸€æ‹
    async function avatarDoubleClick() {
        const pokeAction = localStorage.getItem('user_poke_text') || "æ‹äº†æ‹";
        chatHistory[currentPartner].push({ 
            role: 'system_notify', 
            type: 'poke',
            content: `æˆ‘æ‹äº†æ‹${personas[currentPartner].name}${pokeAction}` 
        });
        saveHistoryToLocal();
        renderChat();
        await processAIResponse(currentPartner);
    }

    // AIå¤„ç†é€»è¾‘ (ä¿®å¤ç‰ˆ)
    async function processAIResponse(targetPartnerId) {
        const replyBtn = document.getElementById('reply-btn');
        replyBtn.disabled = true;
        
        typingStatus[targetPartnerId] = true;
        if(currentPartner === targetPartnerId) showTypingIndicator(); 

        const apiKey = localStorage.getItem('apiKey');
        let apiUrl = localStorage.getItem('apiUrl');
        const apiModel = localStorage.getItem('apiModel') || 'gpt-3.5-turbo';

        if (!apiUrl || !apiKey) {
            typingStatus[targetPartnerId] = false;
            if(currentPartner === targetPartnerId) removeTypingIndicator();
            chatHistory[targetPartnerId].push({ role: 'assistant', content: '(è¯·å…ˆå»è®¾ç½®é¡µé¢é…ç½®Keyå’ŒURL)' });
            if(currentPartner === targetPartnerId) renderChat();
            replyBtn.disabled = false;
            return;
        }

        if (!apiUrl.includes('/chat/completions')) {
            apiUrl = apiUrl.replace(/\/$/, ''); 
            if(!apiUrl.includes('/v1')) apiUrl += '/v1';
            apiUrl += '/chat/completions';
        }

        const messagesToSend = [
            { role: "system", content: personas[targetPartnerId].prompt },
            ...chatHistory[targetPartnerId].map(m => {
                let textForAI = m.content; 
                if (m.type === 'transfer') textForAI = `(ç³»ç»Ÿäº‹ä»¶ï¼šç”¨æˆ·è½¬è´¦Â¥${m.amount}ï¼Œå¤‡æ³¨â€œ${m.note}â€)`;
                if (m.type === 'voice') textForAI = `(ç³»ç»Ÿäº‹ä»¶ï¼šç”¨æˆ·å‘æ¥ä¸€æ¡è¯­éŸ³ï¼šâ€œ${m.content}â€)`;
                if (m.type === 'poke') {
                    const action = localStorage.getItem('user_poke_text') || "æ‹äº†æ‹";
                    textForAI = `(ç³»ç»Ÿäº‹ä»¶ï¼šç”¨æˆ·åŠ¨ä½œï¼š${action})`;
                    return { role: 'user', content: textForAI };
                }
                if (m.role === 'system_notify') return null;
                return { role: m.role, content: textForAI };
            }).filter(m => m !== null)
        ];

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
                body: JSON.stringify({ model: apiModel, messages: messagesToSend, temperature: 0.8 })
            });
            if (!response.ok) throw new Error('API Error');
            const data = await response.json();
            const fullReply = data.choices[0].message.content;
            
            typingStatus[targetPartnerId] = false;
            const isUserInThisChat = (currentPartner === targetPartnerId);
            if(isUserInThisChat) removeTypingIndicator(); 

            // è§£æç‰¹æ®Šæ¶ˆæ¯
            let textReply = fullReply;
            let specialMsg = null;

            // 1. æŸ¥çº¢åŒ…
            const transferPattern = /\[è½¬è´¦[:ï¼š](\d+)[:ï¼š](.+?)\]/;
            let match = fullReply.match(transferPattern);
            if (match) {
                specialMsg = { type: 'transfer', amount: match[1], note: match[2], content: `[è½¬è´¦] Â¥${match[1]} - ${match[2]}` };
                textReply = fullReply.replace(match[0], '').trim();
            }

            // 2. æŸ¥è¯­éŸ³
            if (!specialMsg) {
                const voicePattern = /\[è¯­éŸ³[:ï¼š](.+?)\]/;
                match = fullReply.match(voicePattern);
                if (match) {
                    specialMsg = { type: 'voice', content: match[1] };
                    textReply = fullReply.replace(match[0], '').trim();
                }
            }

            // åˆ†æ®µå‘é€
            const segments = textReply.split('\n').filter(s => s.trim() !== '');
            let i = 0;
            function sendNextSegment() {
                if (i < segments.length) {
                    const msgObj = { role: 'assistant', content: segments[i] };
                    chatHistory[targetPartnerId].push(msgObj);
                    
                    if(currentPartner === targetPartnerId) appendOneMessage(msgObj);
                    else { unreadCounts[targetPartnerId]++; updateBadges(); }
                    saveHistoryToLocal();
                    
                    i++;
                    setTimeout(sendNextSegment, 550); 
                } 
                else if (specialMsg) {
                    const finalMsg = { role: 'assistant', ...specialMsg };
                    chatHistory[targetPartnerId].push(finalMsg);
                    
                    if(currentPartner === targetPartnerId) appendOneMessage(finalMsg);
                    else { unreadCounts[targetPartnerId]++; updateBadges(); }
                    saveHistoryToLocal();
                    
                    specialMsg = null;
                    replyBtn.disabled = false;
                } 
                else {
                    replyBtn.disabled = false;
                }
            }
            sendNextSegment();

        } catch (error) {
            typingStatus[targetPartnerId] = false;
            if(currentPartner === targetPartnerId) {
                removeTypingIndicator();
                chatHistory[targetPartnerId].push({ role: 'assistant', content: '(è¿æ¥å‡ºé”™: ' + error.message + ')' });
                renderChat();
            }
            replyBtn.disabled = false;
        }
    }

    // --- 4. ç•Œé¢æ¸²æŸ“å‡½æ•° ---

    function appendOneMessage(msg) {
        const box = document.getElementById('chat-box');
        if (msg.role === 'system_notify') {
            const div = document.createElement('div');
            div.className = 'system-message';
            div.innerText = msg.content;
            box.appendChild(div);
            requestAnimationFrame(() => { box.scrollTo({ top: box.scrollHeight, behavior: 'smooth' }); });
            return;
        }

        const isUser = msg.role === 'user';
        const partner = personas[currentPartner];
        const userCustomAvatar = localStorage.getItem('theme_user_avatar');
        const userAvatar = userCustomAvatar && userCustomAvatar.trim() !== '' ? userCustomAvatar : DEFAULTS.user_avatar;
        const avatarSrc = isUser ? userAvatar : partner.avatar;

        const row = document.createElement('div');
        row.className = `message-row ${isUser ? 'right' : 'left'}`;
        
        const imgHtml = `<img class="chat-avatar" src="${avatarSrc}" ondblclick="avatarDoubleClick()">`;
        let bubbleHtml = '';
        
        if (msg.type === 'transfer') {
            bubbleHtml = `<div class="message-bubble transfer-bubble"><div class="transfer-icon">Â¥</div><div class="transfer-content"><h3>Â¥${msg.amount}</h3><p>${msg.note}</p></div></div>`;
        } else if (msg.type === 'voice') {
            // è¯­éŸ³æ¡é€»è¾‘ï¼šæ ¹æ®å­—æ•°ç®—æ—¶é—´
            const seconds = Math.max(2, Math.ceil(msg.content.length / 3));
            // é•¿åº¦ä¹Ÿä¼šæ ¹æ®æ—¶é—´å˜é•¿ä¸€ç‚¹
            const width = Math.min(200, 60 + seconds * 10); 
            
            // å¥¶å¥¶çœ‹è¿™é‡Œï¼šè¿™æ˜¯æ–°çš„éŸ³æ³¢å›¾å½¢ï¼Œä¸æ˜¯åœŸåœŸçš„æ‹¬å·äº†
            const waveHtml = `
                <div class="wave-box">
                    <div class="wave-line"></div>
                    <div class="wave-line"></div>
                    <div class="wave-line"></div>
                </div>`;
            
            bubbleHtml = `
            <div class="message-bubble voice-bubble" style="width:${width}px" onclick="this.querySelector('.voice-text').style.display='block'">
                <div class="voice-bar">
                    ${waveHtml} 
                    <span class="voice-duration">${seconds}"</span>
                </div>
                <div class="voice-text">${msg.content}</div>
            </div>`;
        } else {
            // æ™®é€šæ–‡å­—
            bubbleHtml = `<div class="message-bubble">${msg.content}</div>`;
        }

        row.innerHTML = imgHtml + bubbleHtml;
        box.appendChild(row);
        
        requestAnimationFrame(() => {
            box.scrollTo({ top: box.scrollHeight, behavior: 'smooth' });
        });
    }

    function renderChat() {
        const box = document.getElementById('chat-box');
        box.innerHTML = '';
        const history = chatHistory[currentPartner];
        history.forEach(msg => { if(msg.role !== 'system') appendOneMessage(msg); });
        
        if(typingStatus[currentPartner]) showTypingIndicator();
    }

    function showTypingIndicator() {
        const box = document.getElementById('chat-box');
        if(document.getElementById('typing-bubble')) return;
        const row = document.createElement('div');
        row.className = 'message-row left';
        row.id = 'typing-bubble';
        row.innerHTML = `<img class="chat-avatar" src="${personas[currentPartner].avatar}"><div class="typing-indicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;
        box.appendChild(row);
        box.scrollTo({ top: box.scrollHeight, behavior: 'smooth' });
    }
    function removeTypingIndicator() { const el = document.getElementById('typing-bubble'); if(el) el.remove(); }

    function renderContactList() {
        const container = document.getElementById('contact-list-container');
        container.innerHTML = '';
        Object.values(personas).forEach(p => {
            const history = chatHistory[p.id];
            let lastMsg = p.statusText;
            if (history.length > 0) {
                for(let i = history.length - 1; i >= 0; i--) {
                    const m = history[i];
                    if(m.role !== 'system' && m.role !== 'system_notify') {
                        lastMsg = m.content;
                        if(m.type === 'transfer') lastMsg = '[è½¬è´¦çº¢åŒ…]';
                        else if(m.type === 'voice') lastMsg = '[è¯­éŸ³]';
                        else if(lastMsg.length > 15) lastMsg = lastMsg.substring(0, 15) + '...';
                        break;
                    }
                }
            }
            const badgeHtml = `<div id="badge-${p.id}" class="contact-badge ${unreadCounts[p.id]>0?'show':''}">${unreadCounts[p.id]}</div>`;
            const div = document.createElement('div');
            div.className = 'contact-item';
            div.innerHTML = `<div class="contact-avatar-box"><img src="${p.avatar}" class="avatar">${badgeHtml}</div><div class="contact-info"><div class="contact-top"><span class="contact-name">${p.name}</span><span class="contact-time">åˆšåˆš</span></div><div class="contact-preview">${lastMsg}</div></div>`;
            div.addEventListener('click', function() { startChat(p.id); });
            container.appendChild(div);
        });
    }

    // --- 5. è¾…åŠ©åŠŸèƒ½å‡½æ•° ---

    function handleImageUpload(input, storageKey, previewId) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 800; const MAX_HEIGHT = 800;
                    let width = img.width; let height = img.height;
                    if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } } 
                    else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } }
                    canvas.width = width; canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                    localStorage.setItem(storageKey, dataUrl);
                    document.getElementById(previewId).src = dataUrl;
                    loadTheme();
                    if(currentPartner) renderChat();
                };
            };
            reader.readAsDataURL(file);
        }
    }

    function saveHistoryToLocal() { 
        localStorage.setItem('chat_history_v2', JSON.stringify(chatHistory)); 
        localStorage.setItem('chat_unread_v2', JSON.stringify(unreadCounts));
    }

    function clearCurrentChat() {
        if(!currentPartner) return;
        if(confirm(`å¥¶å¥¶ï¼Œæ‚¨ç¡®å®šè¦åˆ æ‰å’Œ ${personas[currentPartner].name} çš„æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿåˆ äº†å°±æ‰¾ä¸å›äº†å“¦ã€‚`)) {
            chatHistory[currentPartner] = [];
            saveHistoryToLocal();
            renderChat();
            closeModal('chat-settings-modal');
        }
    }

    function updateBadges() {
        let total = 0;
        Object.keys(unreadCounts).forEach(key => {
            total += unreadCounts[key];
            const contactBadge = document.getElementById('badge-' + key);
            if(contactBadge) {
                if(unreadCounts[key] > 0) {
                    contactBadge.innerText = unreadCounts[key];
                    contactBadge.classList.add('show');
                } else {
                    contactBadge.classList.remove('show');
                }
            }
        });
        const dockBadge = document.getElementById('dock-badge-qq');
        if(total > 0) {
            dockBadge.innerText = total > 99 ? '99+' : total;
            dockBadge.classList.add('show');
        } else {
            dockBadge.classList.remove('show');
        }
    }

    function openApp(pageId) {
        document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
        document.getElementById('page-' + pageId).classList.add('active');
        if(pageId === 'qq-list') renderContactList();
        if(pageId !== 'chat') {
            currentPartner = '';
        }
    }

    function toggleActionSheet() { document.getElementById('action-sheet').classList.toggle('open'); }
    function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }

    function openTransferModal() {
        document.getElementById('transfer-modal').style.display = 'flex';
        toggleActionSheet();
    }
    function sendTransfer() {
        const amt = document.getElementById('transfer-amount').value;
        const note = document.getElementById('transfer-note').value || 'è½¬è´¦ç»™æ‚¨';
        if(!amt) { alert('è¯·è¾“å…¥é‡‘é¢'); return; }
        closeModal('transfer-modal');
        const transferMsg = { role: 'user', type: 'transfer', amount: amt, note: note, content: `[è½¬è´¦] Â¥${amt} - ${note}` };
        chatHistory[currentPartner].push(transferMsg);
        saveHistoryToLocal(); 
        renderChat();
    }

    function openChatSettings() {
        const avatar = localStorage.getItem('theme_user_avatar') || DEFAULTS.user_avatar;
        const pokeText = localStorage.getItem('user_poke_text') || "";
        document.getElementById('preview-user-avatar').src = avatar;
        document.getElementById('setting-poke-text').value = pokeText;
        document.getElementById('chat-settings-modal').style.display = 'flex';
    }

    function saveChatSettings() {
        const pokeText = document.getElementById('setting-poke-text').value.trim();
        localStorage.setItem('user_poke_text', pokeText);
        closeModal('chat-settings-modal');
        alert('ä¿®æ”¹æˆåŠŸå•¦ï¼');
    }

    function startChat(partnerId) {
        currentPartner = partnerId;
        unreadCounts[partnerId] = 0;
        saveHistoryToLocal();
        updateBadges();
        document.getElementById('chat-title').innerText = personas[partnerId].name;
        openApp('chat');
        renderChat();
    }

    async function testConnection() {
        const btn = document.getElementById('test-conn-btn');
        const key = document.getElementById('api-key').value.trim();
        let url = document.getElementById('api-url').value.trim();
        const modelSelect = document.getElementById('api-model');
        if(!key || !url) { alert('è¯·å…ˆå¡«å†™ Key å’Œ åœ°å€'); return; }
        if (!url.includes('/v1')) url = url.replace(/\/$/, '');
        btn.innerText = "è¿æ¥ä¸­..."; btn.disabled = true;
        try {
            const apiUrl = url.includes('/v1') ? url + '/models' : url + '/v1/models';
            const response = await fetch(apiUrl, { method: 'GET', headers: { 'Authorization': 'Bearer ' + key } });
            if(response.ok) {
                const data = await response.json();
                btn.innerText = "æˆåŠŸ!"; btn.style.background = "#34c759";
                document.getElementById('model-section').style.opacity = '1';
                document.getElementById('model-section').style.pointerEvents = 'auto';
                modelSelect.innerHTML = '';
                const commonModels = ['gpt-3.5-turbo', 'gpt-4', 'gpt-4o', 'deepseek-chat', 'claude-3-5-sonnet-20240620'];
                if(data.data && Array.isArray(data.data)) { data.data.forEach(m => { let opt = document.createElement('option'); opt.value = m.id; opt.text = m.id; modelSelect.add(opt); }); } 
                else { commonModels.forEach(m => { let opt = document.createElement('option'); opt.value = m; opt.text = m; modelSelect.add(opt); }); }
            } else { throw new Error('Status ' + response.status); }
        } catch (e) { alert('è¿æ¥å¤±è´¥ï¼š' + e.message); btn.innerText = "é‡è¯•"; btn.style.background = "#ff9500"; document.getElementById('model-section').style.opacity = '1'; document.getElementById('model-section').style.pointerEvents = 'auto'; } finally { btn.disabled = false; }
    }
    
    function saveSettings() {
        localStorage.setItem('apiKey', document.getElementById('api-key').value.trim());
        localStorage.setItem('apiUrl', document.getElementById('api-url').value.trim());
        localStorage.setItem('apiModel', document.getElementById('api-model').value.trim());
        alert('è®¾ç½®å·²ä¿å­˜ï¼'); openApp('home');
    }
    
    function updateClock() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        document.getElementById('status-time').innerText = `${hours}:${minutes}`;
        document.getElementById('big-time').innerText = `${hours}:${minutes}`;
        const days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
        document.getElementById('big-date').innerText = `${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ ${days[now.getDay()]}`;
    }
    
    function loadTheme() {
        const bg = localStorage.getItem('theme_bg') || DEFAULTS.bg;
        document.getElementById('page-home').style.backgroundImage = `url('${bg}')`;
        document.getElementById('page-chat').style.backgroundImage = `url('${bg}')`;
        document.getElementById('icon-qq-img').src = localStorage.getItem('theme_qq') || DEFAULTS.icon_qq;
        document.getElementById('icon-settings-img').src = localStorage.getItem('theme_settings') || DEFAULTS.icon_settings;
        document.getElementById('icon-theme-img').src = localStorage.getItem('theme_icon') || DEFAULTS.icon_theme;
        document.getElementById('preview-bg').src = bg;
        document.getElementById('preview-qq').src = localStorage.getItem('theme_qq') || DEFAULTS.icon_qq;
        document.getElementById('preview-settings').src = localStorage.getItem('theme_settings') || DEFAULTS.icon_settings;
        document.getElementById('preview-theme').src = localStorage.getItem('theme_theme') || DEFAULTS.icon_theme;
    }
</script>

</body>
</html>